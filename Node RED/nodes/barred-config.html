<script type="text/javascript" src="resources/@marcus-j-davies/node-red-barred/qrcode.min.js"></script>
<script type="text/javascript">
	let EditingBarredConfig;
	RED.nodes.registerType('barred-config', {
		category: 'config',
		defaults: {
			name: { value: 'BARRED Config', required: true },
			department: { value: 'GOODS IN', required: true },
			color: { value: '#e49191', required: true },
			rate: { value: 1000, required: true },
			rtimeout: { value: 500, required: true },
			scanners: { value: {}, required: true },
			host: { value: '', required: true },
			port: { value: '', required: true }
		},
		label: function () {
			return this.name;
		},
		oneditprepare: SortUI,
		oneditsave: SaveScanners
	});

	function getHost() {
		return window.location;
	}

	function genPort() {
		return Math.floor(Math.random() * (60000 - 50000 + 1) + 50000);
	}

	async function gzipString(inputStr) {
		const encoder = new TextEncoder();
		const inputData = encoder.encode(inputStr);
		const inputStream = new Response(inputData).body;
		const compressionStream = new CompressionStream('gzip');
		const compressedStream = inputStream.pipeThrough(compressionStream);
		const compressedResponse = new Response(compressedStream);
		const compressedBlob = await compressedResponse.blob();
		const arrayBuffer = await compressedBlob.arrayBuffer();

		const uint8Array = new Uint8Array(arrayBuffer);
		let binary = '';
		for (let i = 0; i < uint8Array.length; i++) {
			binary += String.fromCharCode(uint8Array[i]);
		}
		const base64String = btoa(binary);

		return base64String;
	}

	async function GenQR(Index) {
		const data = await new Promise((resolve, reject) => {
			$.getJSON('barred-api/getversion').done(resolve).fail(reject);
		});
		const Obj = {
			StackEndpoint: `http://${$('#node-config-input-host').val()}:${$('#node-config-input-port').val()}`,
			Namespace: `/barred-${EditingBarredConfig}/`,
			StackVersion: data.version,
			Group: $('#node-config-input-department').val(),
			ScanRate: Number($('#node-config-input-rate').val()),
			Theme: {
				Color: $('#node-config-input-color').val(),
				IconURL: `http://${$('#node-config-input-host').val()}:${getHost().port}/barred-api/geticon/${EditingBarredConfig}`
			},
			ClientID: $(`#scanner_${Index}_id`).val(),
			ClientLabel: $(`#scanner_${Index}_name`).val()
		};

		const GZIPB64 = await gzipString(JSON.stringify(Obj));

		$(`#barred-qr-${Index}`).empty();

		const QR = new QRCode(document.getElementById(`barred-qr-${Index}`), {
			text: GZIPB64,
			width: 160,
			height: 160,
			colorDark: '#000000',
			colorLight: '#ffffff',
			correctLevel: QRCode.CorrectLevel.L
		});

		setTimeout(() => {
			$(`#barred-qr-${Index}`).find('img').css('display', '');
		}, 100);
	}

	function GenerateUUID() {
		var d = new Date().getTime();
		var d2 = (typeof performance !== 'undefined' && performance.now && performance.now() * 1000) || 0;
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
			var r = Math.random() * 16;
			if (d > 0) {
				r = (d + r) % 16 | 0;
				d = Math.floor(d / 16);
			} else {
				r = (d2 + r) % 16 | 0;
				d2 = Math.floor(d2 / 16);
			}
			return (c === 'x' ? r : (r & 0x3) | 0x8).toString(16);
		});
	}

	function UpdateData(Data, Property, El) {
		Data[Property] = $(El).val();
	}

	function AddItem(container, index, data) {
		if (!data.scannerId) {
			data.index = index;
			data.scannerLabel = 'Scanner A';
			data.scannerId = GenerateUUID();
		}

		$(container).data('data', data);
		$(container).css({ minWidth: '400px' });

		const HTML = `
				<div class="form-row">
					<label for="scanner_${index}_name"><i class="fa fa-tag"></i> Name</label>
					<input type="text" id="scanner_${index}_name" value="${data.scannerLabel}">
				</div>
				<div class="form-row">
					<label for="${index}_id"><i class="fa fa-id-card-o"></i> ID</label>
					<input type="text" id="scanner_${index}_id"  value="${data.scannerId}" readonly="readonly">
				</div>
				<div class="form-row">
					<label for="scanner_${index}_qr"><i class="fa fa-barcode"></i> Invitiation</label>
					<button onclick="GenQR('${index}')" id="scanner_${index}_qr">Generate QR Code</button>
				</div>
				<div class="form-tips" style="margin:auto">
			      Ensure the QR code is scanned <strong>AFTER</strong> you have deployed any changes, generate it again - <strong>AFTER</strong> a deploy if needed.
				</div>
				<div id="barred-qr-${index}" style="text-align: center;margin: auto; margin-top:10px; margoin-bottom:10px"></div>

			`;

		$(container).html(HTML);

		$(container)
			.find(`#scanner_${index}_name`)
			.on('change', function () {
				UpdateData(data, 'scannerLabel', this);
				RED.nodes.dirty(EditingBarredConfig);
			});
	}

	function SaveScanners() {
		const Scanners = $('#scanners').editableList('items');
		this.scanners = {};
		for (let i = 0; i < Scanners.length; i++) {
			const ScannerData = Scanners[i].data('data');
			this.scanners[ScannerData.scannerId] = ScannerData;
		}
	}

	function SortUI() {
		EditingBarredConfig = this.id;

		if (!this.host) {
			this.host = getHost().hostname;
			$('#node-config-input-host').val(this.host);
		}

		if (!this.port) {
			this.port = genPort();
			$('#node-config-input-port').val(this.port);
		}

		$('#scanners').editableList({
			header: $('<div>').append('<div>Scanners</div>'),
			removable: true,
			addButton: 'Add Scanner',
			addItem: AddItem
		});

		Object.values(this.scanners).forEach((S) => {
			console.log(S);
			$('#scanners').editableList('addItem', S);
		});
	}

	async function UploadPNG(Input) {
		const file = Input.files[0];
		if (!file) return;
		const response = await fetch(`barred-api/seticon/${EditingBarredConfig}`, {
			method: 'POST',
			headers: {
				'Content-Type': 'image/png'
			},
			body: file
		});

		if (!response.ok) {
			alert(await response.text());
		} else {
			alert('PNG Uploaded to Node RED for');
		}
	}
</script>

<!-- prettier-ignore -->
<script type="text/x-red" data-template-name="barred-config">
    
    <h3>Basic</h3>
	<hr />
	<div class="form-row">
	    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
	    <input type="text" id="node-config-input-name">
	</div>

    <h3>Branding</h3>
	<hr />
	<div class="form-row">
	    <label for="node-config-input-department"><i class="fa fa-building"></i> Department</label>
	    <input type="text" id="node-config-input-department" placeholder="GOODS IN">
	</div>
    <div class="form-row">
	    <label for="node-config-input-color"><i class="fa fa-paint-brush"></i> Color Theme</label>
	    <input type="color" id="node-config-input-color" placeholder="#e49191">
	</div>
    <div class="form-row">
	    <label for="node-config-input-logo"><i class="fa fa-picture-o"></i> Logo</label>
	    <input type="file" accept="image/png" onchange="UploadPNG(this)">
	</div>

	<h3>Settings</h3>
	<hr />
	<div class="form-row">
	    <label for="node-config-input-rate"><i class="fa fa-repeat"></i> Scan Rate</label>
	    <input type="number" id="node-config-input-rate" placeholder="1000">
	</div>
	<div class="form-row">
	    <label for="node-config-input-rtimeout"><i class="fa fa-hourglass"></i> Result Timeout</label>
	    <input type="number" id="node-config-input-rtimeout" placeholder="500">
	</div>
	<div class="form-row">
	    <label for="node-config-input-host"><i class="fa fa-globe"></i> Host</label>
	    <input type="text" id="node-config-input-host" placeholder="x.x.x.x">
	</div>
	<div class="form-row">
	    <label for="node-config-input-port"><i class="fa fa-globe"></i> Port</label>
	    <input type="text" id="node-config-input-port" placeholder="xxxxx">
	</div>
	<div class="form-tips" style="margin:auto">
		Update the <strong>Host</strong> value, if it does not represent the IP/Hostname that the scanner will connect to, i.e 127.0.0.1 is likely incorrect. Ensure the <strong>Port</strong> is not in use by any other instance or another service on the host.
	</div>

	<h3>Scanners</h3>
	<hr />
	<div>
	      <ol id="scanners" style="min-height:350px;min-width:400px"> </ol>
	</div>
	

</script>

<!-- prettier-ignore -->
<script type="text/markdown" data-help-name="barred-config">
<p>BARRED Config Node</p>
</script>
